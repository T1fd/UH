{
 'Реквизиты': {
  'Наименование': 'Оповещение о сбое данных - Неактивные руководители проектов',
  'ТекстОбработки': '	//------------------------------------------------------------------------------
	//ПАРАМЕТРЫ                                          
	//------------------------------------------------------------------------------
	Отладка = Ложь;   
	 
	ДатаНачалаВыгрузки = ТекущаяДата();
	ТемаСообщения = ""+Система+" - Оповещение о неактивных руководителях или КАМ проектов "+Формат(ДатаНачалаВыгрузки,"ДФ=dd.MM.yyyy");  
	
	ПочтаПолучателей = "ssmirnov@t1.ru, nmoskalenko@t1.ru";   
	 
	ГуидУчетнойЗаписиПочты = "12f1aa09-8983-11ec-96d9-005056015ee4";
	 
    Если Отладка Тогда 
    	ПочтаПолучателей = "ssmirnov@t1.ru";
    КонецЕсли;
	
	СимволПереносаСтроки = Символы.ПС + Символы.ВК;
	ТекстСообщения = "Наименование руководителя или КАМ"+ Символы.ТАБ+"пример проекта"+ Символы.ТАБ+"навигационная ссылка" + СимволПереносаСтроки;
	
	//------------------------------------------------------------------------------
	//Сбор данных
	//------------------------------------------------------------------------------  
	пТекстЗапросаТекущейСистемы = ПолучитьЗначениеПеременной(Переменные,"ТекстЗапроса",Система);
	  	
	Запрос_КОМ = Соединение.NewObject("Запрос");
	Запрос_КОМ.Текст = пТекстЗапросаТекущейСистемы;  
	ПустойУИД_КОМ = Соединение.NewObject("УникальныйИдентификатор","00000000-0000-0000-0000-000000000000");
	Запрос_КОМ.УстановитьПараметр("ПустойУИД",ПустойУИД_КОМ); 
	
	ПП = 0;
	Выборка_КОМ = Запрос_КОМ.Выполнить().Выбрать();
	Пока Выборка_КОМ.Следующий() Цикл
		ПП=ПП+1;
		НавСсылка = Соединение.ПолучитьНавигационнуюСсылку(Выборка_КОМ.РуководительСсылка);
		ТекстСообщения = ТекстСообщения
			+ ПП +"."+ Символы.ТАБ  
			+ Выборка_КОМ.РуководительНаименование + Символы.ТАБ  
			+ Выборка_КОМ.ПроектСсылка.Наименование + Символы.ТАБ
			+ НавСсылка + СимволПереносаСтроки; 
			
		Если ПП >= 100 Тогда
			ТекстСообщения = ТекстСообщения + "........ и другие, их можно получить запросом:" + СимволПереносаСтроки+пТекстЗапросаТекущейСистемы; 
			Прервать;
		КонецЕсли; 
	КонецЦикла; 
	   
	//------------------------------------------------------------------------------
	//Отправка письма
	//------------------------------------------------------------------------------
	Если Выборка_КОМ.Количество() > 0 Тогда		 					  
		Алгоритм("ОтправитьEmail",ЗапросСсылка,ПочтаПолучателей,ТемаСообщения,ТекстСообщения,ТипТекстаПочтовогоСообщения.РазмеченныйТекст,ГуидУчетнойЗаписиПочты);	
		СтрокаОшибок = СтрокаОшибок + ""+Система+" - сообщения отправлены"+Символы.ПС;
	КонецЕсли;	
	
	Если не Отладка Тогда
		УстановитьДатуПоследнейВыгрузки(Система,ЗапросСсылка,ДатаНачалаВыгрузки);
	КонецЕсли;',
  'Комментарий': 'Не оповещает, если пользователь действительный, но у него нет ни одного варианта входа в 1С

Источник: Запрос. Вывод: текст'
 },
 'ТЧ': [
  {
   'Переменные': [
    {
     'Имя': 'ТекстЗапроса',
     'Разделитель': 'e1cib/data/Справочник.Т1_ИнформационныеБазы?ref=96d8005056015ee411ec47a45a795e98',
     'ЗначениеСтрока': 'ВЫБРАТЬ
	Проекты.Ссылка КАК Ссылка,
	Проекты.Расш1_ДиректорПроекта КАК Расш1_ДиректорПроекта,
	Проекты.Расш1_МенеджерПроекта КАК Расш1_МенеджерПроекта,
	ЕСТЬNULL(РегистрСостоянийОбъектовСрезПоследних.СостояниеОбъекта, ЗНАЧЕНИЕ(Перечисление.СостоянияПроектов.Черновик)) КАК СостояниеОбъекта
ПОМЕСТИТЬ ВТПроектыКПроверке
ИЗ
	Справочник.Проекты КАК Проекты
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РегистрСостоянийОбъектов.СрезПоследних КАК РегистрСостоянийОбъектовСрезПоследних
		ПО (Проекты.Ссылка = (ВЫРАЗИТЬ(РегистрСостоянийОбъектовСрезПоследних.Объект КАК Справочник.Проекты)))
ГДЕ
	НЕ Проекты.ПометкаУдаления
	И НЕ ЕСТЬNULL(РегистрСостоянийОбъектовСрезПоследних.СостояниеОбъекта, ЗНАЧЕНИЕ(Перечисление.СостоянияПроектов.Черновик)) В (ЗНАЧЕНИЕ(Перечисление.СостоянияПроектов.Завершен))
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВсеОшибочныеРуководители.Руководитель КАК РуководительСсылка,
	ВсеОшибочныеРуководители.Руководитель.Наименование КАК РуководительНаименование,
	МАКСИМУМ(ВсеОшибочныеРуководители.ПроектСсылка) КАК ПроектСсылка
ИЗ
	(ВЫБРАТЬ
		ВТПроектыКПроверке.Расш1_ДиректорПроекта КАК Руководитель,
		ВТПроектыКПроверке.Ссылка КАК ПроектСсылка
	ИЗ
		ВТПроектыКПроверке КАК ВТПроектыКПроверке
	ГДЕ
		(ВТПроектыКПроверке.Расш1_ДиректорПроекта.Недействителен
				ИЛИ ВТПроектыКПроверке.Расш1_ДиректорПроекта.ИдентификаторПользователяИБ = &ПустойУИД)
	
	ОБЪЕДИНИТЬ ВСЕ
	
	ВЫБРАТЬ
		ВТПроектыКПроверке.Расш1_МенеджерПроекта,
		ВТПроектыКПроверке.Ссылка
	ИЗ
		ВТПроектыКПроверке КАК ВТПроектыКПроверке
	ГДЕ
		(ВТПроектыКПроверке.Расш1_МенеджерПроекта.Недействителен
				ИЛИ ВТПроектыКПроверке.Расш1_МенеджерПроекта.ИдентификаторПользователяИБ = &ПустойУИД)) КАК ВсеОшибочныеРуководители

СГРУППИРОВАТЬ ПО
	ВсеОшибочныеРуководители.Руководитель,
	ВсеОшибочныеРуководители.Руководитель.Наименование',
     'Комментарий': ''
    },
    {
     'Имя': 'ТекстЗапроса',
     'Разделитель': 'e1cib/data/Справочник.Т1_ИнформационныеБазы?ref=96d8005056015ee411ec486f824da928',
     'ЗначениеСтрока': 'ВЫБРАТЬ
	Проекты.Ссылка КАК Ссылка,
	Проекты.Руководитель КАК Руководитель,
	Проекты.Т1_КАМ КАК Т1_КАМ
ПОМЕСТИТЬ ВТПроектыКПроверке
ИЗ
	Справочник.Проекты КАК Проекты
ГДЕ
	НЕ Проекты.ПометкаУдаления
	И НЕ Проекты.Т1_СостояниеПроекта В (ЗНАЧЕНИЕ(Перечисление.Т1_СостоянияПроектов.Завершен))
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВсеОшибочныеРуководители.Руководитель КАК РуководительСсылка,
	ВсеОшибочныеРуководители.Руководитель.Наименование КАК РуководительНаименование,
	МАКСИМУМ(ВсеОшибочныеРуководители.ПроектСсылка) КАК ПроектСсылка
ИЗ
	(ВЫБРАТЬ
		ВТПроектыКПроверке.Руководитель КАК Руководитель,
		ВТПроектыКПроверке.Ссылка КАК ПроектСсылка
	ИЗ
		ВТПроектыКПроверке КАК ВТПроектыКПроверке
	ГДЕ
		(ВТПроектыКПроверке.Руководитель.Недействителен
				ИЛИ ВТПроектыКПроверке.Руководитель.ИдентификаторПользователяИБ = &ПустойУИД)
	
	ОБЪЕДИНИТЬ ВСЕ
	
	ВЫБРАТЬ
		ВТПроектыКПроверке.Т1_КАМ,
		ВТПроектыКПроверке.Ссылка
	ИЗ
		ВТПроектыКПроверке КАК ВТПроектыКПроверке
	ГДЕ
		(ВТПроектыКПроверке.Т1_КАМ.Недействителен
				ИЛИ ВТПроектыКПроверке.Т1_КАМ.ИдентификаторПользователяИБ = &ПустойУИД)) КАК ВсеОшибочныеРуководители

СГРУППИРОВАТЬ ПО
	ВсеОшибочныеРуководители.Руководитель,
	ВсеОшибочныеРуководители.Руководитель.Наименование',
     'Комментарий': ''
    }
   ]
  }
 ]
}
