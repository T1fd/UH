{
 'Реквизиты': {
  'Наименование': 'Оповещение о сбое данных - Пользователи',
  'ТекстОбработки': '	//------------------------------------------------------------------------------
	//ПАРАМЕТРЫ                                          
	//------------------------------------------------------------------------------
	Отладка = Ложь;   
	 
	ДатаНачалаВыгрузки = ТекущаяДата();
	ТемаСообщения = ""+Система+" - Неправильно заведенные пользователи 1С "+Формат(ДатаНачалаВыгрузки,"ДФ=dd.MM.yyyy");  
	
	ПочтаПолучателей = "ssmirnov@t1.ru, nmoskalenko@t1.ru";   
	 
	ГуидУчетнойЗаписиПочты = "12f1aa09-8983-11ec-96d9-005056015ee4";
	 
    Если Отладка Тогда 
    	ПочтаПолучателей = "ssmirnov@t1.ru";
    КонецЕсли;
	
	СимволПереносаСтроки = Символы.ПС + Символы.ВК;
	ТекстСообщения = "";
	
	//------------------------------------------------------------------------------
	//Сбор данных
	//------------------------------------------------------------------------------  
	  
	//сложно создавать ТЗ через КОМ, поэтому создаю тут и преобразовываю в КОМ 
	    
	ТЗПользователейИБ = Новый ТаблицаЗначений;
	ТЗПользователейИБ.Колонки.Добавить("УникальныйИдентификатор",новый ОписаниеТипов("УникальныйИдентификатор"));
	ТЗПользователейИБ.Колонки.Добавить("Имя",новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
	ТЗПользователейИБ.Колонки.Добавить("ПолноеИмя",новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
	ТЗПользователейИБ.Колонки.Добавить("АдресЭлектроннойПочты",новый ОписаниеТипов("Строка",,Новый КвалификаторыСтроки(50)));
	ТЗПользователейИБ.Колонки.Добавить("АутентификацияСтандартная",новый ОписаниеТипов("Булево"));
	ТЗПользователейИБ.Колонки.Добавить("ПарольУстановлен",новый ОписаниеТипов("Булево"));
	
	ТЗПользователейИБ.Колонки.Добавить("АутентификацияOpenID",новый ОписаниеТипов("Булево"));
	ТЗПользователейИБ.Колонки.Добавить("АутентификацияОС",новый ОписаниеТипов("Булево"));
	    
		
	//перенести comТЗ в ТЗ
	СтрВнутр = ЗначениеВСтрокуВнутр(ТЗПользователейИБ);
	ТЗПользователейИБ_КОМ = Соединение.ЗначениеИзСтрокиВнутр(СтрВнутр);
	
	ВсеПользователиИБ_КОМ = Соединение.ПользователиИнформационнойБазы.ПолучитьПользователей(); 
	Для каждого ПользовательИБ_КОМ из ВсеПользователиИБ_КОМ Цикл 
		НовСтрТЗ_КОМ = ТЗПользователейИБ_КОМ.Добавить();
		НовСтрТЗ_КОМ.УникальныйИдентификатор = ПользовательИБ_КОМ.УникальныйИдентификатор;
		НовСтрТЗ_КОМ.Имя = ПользовательИБ_КОМ.Имя;
		НовСтрТЗ_КОМ.ПолноеИмя = ПользовательИБ_КОМ.ПолноеИмя;
		НовСтрТЗ_КОМ.АдресЭлектроннойПочты = ПользовательИБ_КОМ.АдресЭлектроннойПочты;
		НовСтрТЗ_КОМ.АутентификацияСтандартная = ПользовательИБ_КОМ.АутентификацияСтандартная;
		НовСтрТЗ_КОМ.ПарольУстановлен = ПользовательИБ_КОМ.ПарольУстановлен;  
		НовСтрТЗ_КОМ.АутентификацияOpenID = ПользовательИБ_КОМ.АутентификацияOpenID;
		НовСтрТЗ_КОМ.АутентификацияОС = ПользовательИБ_КОМ.АутентификацияОС;
	КонецЦикла;
	
	
	Запрос_КОМ = Соединение.NewObject("Запрос");
	Запрос_КОМ.Текст = 
		"ВЫБРАТЬ
		|	ТЗПользователейИБ.Имя КАК Имя,
		|	ТЗПользователейИБ.ПолноеИмя КАК ПолноеИмя,
		|	ТЗПользователейИБ.УникальныйИдентификатор КАК УникальныйИдентификатор,
		|	ТЗПользователейИБ.АдресЭлектроннойПочты КАК АдресЭлектроннойПочты,
		|	ТЗПользователейИБ.АутентификацияСтандартная КАК АутентификацияСтандартная,
		|	ТЗПользователейИБ.ПарольУстановлен КАК ПарольУстановлен,
		|	ТЗПользователейИБ.АутентификацияOpenID КАК АутентификацияOpenID,
		|	ТЗПользователейИБ.АутентификацияОС КАК АутентификацияОС
		|ПОМЕСТИТЬ ВТПользователиИБ
		|ИЗ
		|	&ТЗПользователейИБ КАК ТЗПользователейИБ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТПользователиИБ.Имя КАК Имя,
		|	ВТПользователиИБ.ПолноеИмя КАК ПолноеИмя,
		|	ВТПользователиИБ.УникальныйИдентификатор КАК УникальныйИдентификатор,
		|	ВТПользователиИБ.АдресЭлектроннойПочты КАК АдресЭлектроннойПочты,
		|	ВТПользователиИБ.АутентификацияСтандартная КАК АутентификацияСтандартная,
		|	ВТПользователиИБ.ПарольУстановлен КАК ПарольУстановлен,
		|	ВТПользователиИБ.АутентификацияOpenID КАК АутентификацияOpenID,
		|	ВТПользователиИБ.АутентификацияОС КАК АутентификацияОС,
		|	Пользователи.Ссылка КАК ПользовательСсылка,
		|	МАКСИМУМ(ЕСТЬNULL(ПользователиКонтактнаяИнформация.АдресЭП, """")) КАК Email,
		|	Пользователи.Служебный КАК Служебный
		|ПОМЕСТИТЬ ВТАктивныеПользователи
		|ИЗ
		|	ВТПользователиИБ КАК ВТПользователиИБ
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Пользователи КАК Пользователи
		|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Пользователи.КонтактнаяИнформация КАК ПользователиКонтактнаяИнформация
		|			ПО Пользователи.Ссылка = ПользователиКонтактнаяИнформация.Ссылка
		|				И (ПользователиКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты))
		|				И (ПользователиКонтактнаяИнформация.АдресЭП <> """")
		|		ПО ВТПользователиИБ.УникальныйИдентификатор = Пользователи.ИдентификаторПользователяИБ
		|ГДЕ
		|	НЕ Пользователи.Недействителен
		|	И (ВТПользователиИБ.АутентификацияСтандартная
		|			ИЛИ ВТПользователиИБ.АутентификацияOpenID
		|			ИЛИ ВТПользователиИБ.АутентификацияОС)
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТПользователиИБ.Имя,
		|	ВТПользователиИБ.ПолноеИмя,
		|	ВТПользователиИБ.УникальныйИдентификатор,
		|	ВТПользователиИБ.АдресЭлектроннойПочты,
		|	ВТПользователиИБ.АутентификацияСтандартная,
		|	ВТПользователиИБ.ПарольУстановлен,
		|	ВТПользователиИБ.АутентификацияOpenID,
		|	ВТПользователиИБ.АутентификацияОС,
		|	Пользователи.Ссылка,
		|	Пользователи.Служебный
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТАктивныеПользователи.Имя КАК Имя,
		|	ВТАктивныеПользователи.ПолноеИмя КАК ПолноеИмя,
		|	ВТАктивныеПользователи.ПользовательСсылка КАК ПользовательСсылка,
		|	""Пустой пароль 1С"" КАК Нарушение
		|ИЗ
		|	ВТАктивныеПользователи КАК ВТАктивныеПользователи
		|ГДЕ
		|	ВТАктивныеПользователи.АутентификацияСтандартная
		|	И НЕ ВТАктивныеПользователи.ПарольУстановлен
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТАктивныеПользователи.Имя,
		|	ВТАктивныеПользователи.ПолноеИмя,
		|	ВТАктивныеПользователи.ПользовательСсылка,
		|	""Не установлен email""
		|ИЗ
		|	ВТАктивныеПользователи КАК ВТАктивныеПользователи
		|ГДЕ
		|	ВТАктивныеПользователи.Email = """"
		|	И НЕ ВТАктивныеПользователи.Служебный
		|
		|УПОРЯДОЧИТЬ ПО
		|	ПолноеИмя"; 
	
	Запрос_КОМ.УстановитьПараметр("ТЗПользователейИБ",ТЗПользователейИБ_КОМ);	
	Выборка_КОМ = Запрос_КОМ.Выполнить().Выбрать();
	ПП=0;
	Пока Выборка_КОМ.Следующий() Цикл
		ПП=ПП+1;
		НавСсылка = Соединение.ПолучитьНавигационнуюСсылку(Выборка_КОМ.ПользовательСсылка);
		ТекстСообщения = ТекстСообщения
			+ ПП +"."+ Символы.ТАБ  
			+ Выборка_КОМ.ПолноеИмя + Символы.ТАБ
			+ Выборка_КОМ.Нарушение + Символы.ТАБ
			+ НавСсылка + СимволПереносаСтроки;
	КонецЦикла; 
	   
	//Отправка письма
	Если Выборка_КОМ.Количество() > 0 Тогда		 					  
		Алгоритм("ОтправитьEmail",ЗапросСсылка,ПочтаПолучателей,ТемаСообщения,ТекстСообщения,ТипТекстаПочтовогоСообщения.РазмеченныйТекст,ГуидУчетнойЗаписиПочты);
		СтрокаОшибок = СтрокаОшибок + ""+Система+" - сообщения отправлены"+Символы.ПС;
	КонецЕсли;	
	
	Если не Отладка Тогда
		УстановитьДатуПоследнейВыгрузки(Система,ЗапросСсылка,ДатаНачалаВыгрузки);
	КонецЕсли;',
  'Комментарий': 'Источник: ТЗ. Вывод: текст'
 },
 'ТЧ': [
  {
   'Переменные': []
  }
 ]
}
