{
 'Реквизиты': {
  'Наименование': 'Оповещение о наличии ошибок в ключах аналитик',
  'ТекстОбработки': 'Отладка = Ложь;   
ДатаНачалаВыгрузки = ТекущаяДата();
ПочтаПолучателей = "ssmirnov@t1.ru";
Если Отладка Тогда 
	ПочтаПолучателей = "averzhbitskiy@t1.ru";
КонецЕсли;
СимволПереносаСтроки = Символы.ПС + Символы.ВК;
    
    
ТекстОшибок = Новый Массив;

//Добавляем ключи, которые будут анализироваться 
КлючиДляПроверки = Новый Соответствие;          
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиПланированияНоменклатуры"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаПланированияНоменклатуры"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиПланированияПотребностей"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаПланированияПотребностей"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиПланированияСтатейБюджетов"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаПланированияСтатейБюджетов"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиПланированияСтруктуры"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаПланированияСтруктуры")); 
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиУчетаЗатрат"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаУчетаЗатрат")); 
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиУчетаНДС"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаУчетаНДС")); 
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиАналитикиУчетаПоПартнерам"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаУчетаПоПартнерам")); 
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиКонтроляБюджетныхЛимитовРезервов"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаКонтроляБюджетныхЛимитовРезервов"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиКонтроляЗадолженностиПоКонтрагенту"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаКонтроляЗадолженностиПоКонтрагенту"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиКонтроляПоДоговорам"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаКонтроляПоДоговорам"));
						
КлючиДляПроверки.Вставить(ОбщегоНазначения.ИдентификаторОбъектаМетаданных("Справочник.КлючиПараметровЗакупки"), 
						ОбщегоНазначения.ИдентификаторОбъектаМетаданных("РегистрСведений.АналитикаПараметровЗакупки"));
      
/////////////////////////////////Дубли ключей///////////////////////////////////////////////////      
      
МассивЗапросов = Новый Массив;
Для каждого Стр Из КлючиДляПроверки Цикл 
	ЗапросТекст = "ВЫБРАТЬ ПЕРВЫЕ 1
                  |	КлючиСДублями.КлючиАналитик КАК КлючиАналитик
                  |ИЗ
                  |	(ВЫБРАТЬ
                  |		""&ПолноеИмяОбъектаМетаданных"" КАК КлючиАналитик,
                  |		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТекущийСправочник.Ссылка) КАК Количество,
                  |		&ПоляСправочника
                  |	ИЗ
                  |		&ПолноеИмяОбъектаМетаданных КАК ТекущийСправочник
                  |	
                  |	СГРУППИРОВАТЬ ПО
                  |		&ПоляСправочника
                  |	
                  |	ИМЕЮЩИЕ
                  |		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ТекущийСправочник.Ссылка) > 1) КАК КлючиСДублями";

	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПолноеИмяОбъектаМетаданных", Стр.Ключ.ПолноеИмя);	 

	ТекущийСправочник = ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(Стр.Ключ);

	ШаблонПолей = "ТекущийСправочник.%1";
    МассивПолей = Новый Массив;
	Для каждого Реквизит Из ТекущийСправочник.Реквизиты Цикл
		МассивПолей.Добавить(СтрШаблон(ШаблонПолей, Реквизит.Имя));   
	КонецЦикла;	            
	ПоляСправочника = СтрСоединить(МассивПолей, ",");        
	
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПоляСправочника", ПоляСправочника);	 

	МассивЗапросов.Добавить(ЗапросТекст);
КонецЦикла;   

Запрос = Новый Запрос;
Запрос.Текст = СтрСоединить(МассивЗапросов, " ОБЪЕДИНИТЬ ВСЕ ");
Выборка = Запрос.Выполнить();
Если НЕ Выборка.Пустой() Тогда  
	ТекстОшибок.Добавить("- Есть дубли ключей аналитик");
КонецЕсли;

/////////////////////////////////Ошибки в РС Аналитик///////////////////////////////////////////////////

МассивЗапросов = Новый Массив;
Для каждого Стр Из КлючиДляПроверки Цикл 
	ЗапросТекст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
                |	""&ПолноеИмяОбъектаМетаданных"" КАК РегистрСведений,
                |	""&ИмяОбъектаМетаданных"" КАК ИмяРегистраСведений,
				|	РСАналитик.КлючАналитики КАК КлючАналитики
				|ИЗ
				|	&ПолноеИмяОбъектаМетаданных КАК РСАналитик
				|ГДЕ
				|	НЕ(&ПоляРавенстваИзмеренийАналитикИКлюча)";

	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПолноеИмяОбъектаМетаданных", Стр.Значение.ПолноеИмя);	 
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ИмяОбъектаМетаданных", Стр.Значение.Имя);	 

	ТекущийРС = ОбщегоНазначения.ОбъектМетаданныхПоИдентификатору(Стр.Значение);

	ШаблонУсловий = "РСАналитик.%1 = РСАналитик.КлючАналитики.%1";
    МассивУсловий = Новый Массив;
	Для каждого Измерение Из ТекущийРС.Измерения Цикл
		МассивУсловий.Добавить(СтрШаблон(ШаблонУсловий, Измерение.Имя));   
	КонецЦикла;	            
	ПоляРавенстваИзмеренийАналитикИКлюча = СтрСоединить(МассивУсловий, " И ");        
	
	ЗапросТекст = СтрЗаменить(ЗапросТекст, "&ПоляРавенстваИзмеренийАналитикИКлюча", ПоляРавенстваИзмеренийАналитикИКлюча);	 

	МассивЗапросов.Добавить(ЗапросТекст);
КонецЦикла;   

Запрос = Новый Запрос;
Запрос.Текст = СтрСоединить(МассивЗапросов, " ОБЪЕДИНИТЬ ВСЕ ");
Выборка = Запрос.Выполнить();
Если НЕ Выборка.Пустой() Тогда  
	ТекстОшибок.Добавить("- Есть неправильные записи о ключах аналитик в РС");
КонецЕсли;
  
/////////////////////////////////Отправка письма, если есть ошибки/////////////////////////////////////
Если ТекстОшибок.Количество() > 0 Тогда       
	
    
	ТемаСообщения = "" + Система + " - есть ошибки в ключах аналитик на " + Формат(ДатаНачалаВыгрузки,"ДФ=dd.MM.yyyy");
	ТекстСообщения = "Необходимо сделать исправление ошибок обработкой: e1c://server/pvm-1c-app-01/DataStorage1C_prod#e1cib/data/Справочник.Обработки?ref=96d9005056015ee411ecc09c680a1ab3" + СимволПереносаСтроки
	+ СтрСоединить(ТекстОшибок, СимволПереносаСтроки);

	ГуидУчетнойЗаписиПочты = "12f1aa09-8983-11ec-96d9-005056015ee4";

		
	Алгоритм("ОтправитьEmail",ЗапросСсылка,ПочтаПолучателей,ТемаСообщения,ТекстСообщения,ТипТекстаПочтовогоСообщения.РазмеченныйТекст,ГуидУчетнойЗаписиПочты);	      
	СтрокаОшибок = СтрокаОшибок + "Отправлено письмо о необходимости исправить ключи аналитик" + СимволПереносаСтроки;
КонецЕсли;',
  'Комментарий': 'Источник: Запросы для аналиаза дублей ключей аналитик и неправильных записей в РС аналитик. Вывод: текст'
 },
 'ТЧ': [
  {
   'Переменные': []
  }
 ]
}
