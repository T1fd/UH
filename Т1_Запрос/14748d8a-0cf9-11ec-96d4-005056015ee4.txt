{
 'Реквизиты': {
  'Наименование': 'Выгрузка Проектов ТСИ',
  'ТекстОбработки': 'Отладка = Ложь;

Обработано = 0;
Выгружено = 0;
ИмяСправочникаПроектов = "T1_Проекты";

ДатаНачалаВыгрузки = ТекущаяДата();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Проекты.Ссылка КАК GUID,
		|	Проекты.Наименование КАК Наименование,
		|	Проекты.Родитель КАК РодительGUID,
		|	Проекты.Проект КАК Проект
		|	,Т1_ПолныйКод КАК Код,
		|	Проекты.Расш1_ДополнительныйКод КАК ДополнительныйКод
		|ИЗ
		|	Справочник.Проекты КАК Проекты
		|ГДЕ
		|	Проекты.Организация В(&ОрганизацииТСИ)";
	МассивОрганизаций = новый Массив;
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("1ea74345-bd4c-11eb-96cf-005056015ee4"))); //ГРУППА ТЕХНОСЕРВ
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("0ee356a6-bd4d-11eb-96cf-005056015ee4"))); //Т1КЛАУД
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("c8ec9af6-bd4d-11eb-96cf-005056015ee4"))); //ТЕХНОСЕРВ АС ООО
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("c760179d-bd4f-11eb-96cf-005056015ee4"))); //ТЕХНОСЕРВ МЕНЕДЖМЕНТ ООО
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("98903ee0-bd50-11eb-96cf-005056015ee4"))); //ТЕХНОСЕРВЪ А/С АО
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("3330a635-bd52-11eb-96cf-005056015ee4"))); //ТЕХНОТРАНССЕРВ ООО
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("8df3b815-bd52-11eb-96cf-005056015ee4"))); //ТРЭЙД ИНВЕСТ ТЕХНОЛОДЖИЗ ООО
	МассивОрганизаций.Добавить(Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("5959cae0-bd53-11eb-96cf-005056015ee4"))); //ТС ИНТЕГРАЦИЯ ООО
			  
	Запрос.УстановитьПараметр("ОрганизацииТСИ", МассивОрганизаций);	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	НомСтр = 0;
	МассивДаныхКЗагрузке = Новый Массив;
	Пока Выборка.Следующий() Цикл
		Обработано = Обработано + 1;
			
		СтруктураДанных = Новый структура();
		СтруктураДанных.Вставить("GUID",XMLСтрока(Выборка.GUID));
		СтруктураДанных.Вставить("РодительGUID",XMLСтрока(Выборка.РодительGUID));
		СтруктураДанных.Вставить("Наименование",Выборка.Наименование);	
		СтруктураДанных.Вставить("Проект",Выборка.Проект);
		СтруктураДанных.Вставить("Код",Выборка.Код);
		СтруктураДанных.Вставить("ДополнительныйКод",Выборка.ДополнительныйКод);
		МассивДаныхКЗагрузке.Добавить(СтруктураДанных);	
		
		//Загрузка
		УИДCOM = Соединение.NewObject("УникальныйИдентификатор",СтруктураДанных.GUID);
		Если ЗначениеЗаполнено(СтруктураДанных.РодительGUID) И СтруктураДанных.РодительGUID <> "00000000-0000-0000-0000-000000000000" Тогда  
			УИДРодителяCOM = Соединение.NewObject("УникальныйИдентификатор",СтруктураДанных.РодительGUID);
			РодительCOM = Соединение.Справочники[ИмяСправочникаПроектов].ПолучитьСсылку(УИДРодителяCOM);
		Иначе
			РодительCOM = Соединение.Справочники[ИмяСправочникаПроектов].ПустаяСсылка();
			
		КонецЕсли;
				
		ТекущаяСсылкаCOM = Соединение.Справочники[ИмяСправочникаПроектов].ПолучитьСсылку(УИДCOM);
		Если Соединение.ОбщегоНазначения.СсылкаСуществует(ТекущаяСсылкаCOM) Тогда
			//надо менять?
			Если ТекущаяСсылкаCOM.Наименование <> СтруктураДанных.Наименование
				ИЛИ  Соединение.XMLСтрока(ТекущаяСсылкаCOM.Родитель) <>  Соединение.XMLСтрока(РодительCOM)
				ИЛИ ТекущаяСсылкаCOM.Проект <> СтруктураДанных.Проект
				ИЛИ ТекущаяСсылкаCOM.Код <> СтруктураДанных.Код
				ИЛИ ТекущаяСсылкаCOM.ДополнительныйКод <> СтруктураДанных.ДополнительныйКод Тогда
				//нужно изменять
				
			Иначе
				Продолжить; //не надо записывать изменения
			КонецЕсли;
			ПроектОбъектCOM = ТекущаяСсылкаCOM.ПолучитьОбъект();
		Иначе
			ПроектОбъектCOM = Соединение.Справочники[ИмяСправочникаПроектов].СоздатьЭлемент();
			ПроектОбъектCOM.УстановитьСсылкуНового(ТекущаяСсылкаCOM);
		КонецЕсли;
		
		ПроектОбъектCOM.Наименование = СтруктураДанных.Наименование;
		ПроектОбъектCOM.Родитель = РодительCOM;
		ПроектОбъектCOM.Проект = СтруктураДанных.Проект;
		ПроектОбъектCOM.Код = СтруктураДанных.Код;
		ПроектОбъектCOM.ДополнительныйКод = СтруктураДанных.ДополнительныйКод;
		ПроектОбъектCOM.ОбменДанными.Загрузка = Истина;
		
		Выгружено = Выгружено + 1;
		Если Отладка Тогда
			Прервать;
			Продолжить;
		КонецЕсли;
		
		ПроектОбъектCOM.Записать();
		
	КонецЦикла;
	
УстановитьДатуПоследнейВыгрузки(Система,ЗапросСсылка,ДатаНачалаВыгрузки);

СтрокаОшибок = СтрокаОшибок + ?(СтрокаОшибок="","",Символы.ПС)+Система +  ": Обработано - "+Обработано+", Выгружено - "+Выгружено;',
  'Комментарий': ''
 },
 'ТЧ': [
  {
   'Переменные': []
  }
 ]
}
